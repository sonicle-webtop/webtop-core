!function(e,t){"object"==typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define([],t):(e.RRule=t(e),e.RRuleSet=e.RRule.RRuleSet,e.rrulestr=e.RRule.rrulestr)}("object"==typeof window?window:this,function(e){var t={MONTH_DAYS:[31,28,31,30,31,30,31,31,30,31,30,31],ONE_DAY:864e5,MAXYEAR:9999,ORDINAL_BASE:new Date(1900,0,1),PY_WEEKDAYS:[6,0,1,2,3,4,5],getYearDay:function(e){var n=new Date(e.getFullYear(),e.getMonth(),e.getDate());return Math.ceil((n-new Date(e.getFullYear(),0,1))/t.ONE_DAY)+1},isLeapYear:function(e){return e%4==0&&e%100!=0||e%400==0},tzOffset:function(e){return 60*e.getTimezoneOffset()*1e3},daysBetween:function(e,n){var r=e.getTime()-t.tzOffset(e)-(n.getTime()-t.tzOffset(n));return Math.round(r/t.ONE_DAY)},toOrdinal:function(e){if(e<t.ORDINAL_BASE)throw new Error("dates lower than "+t.ORDINAL_BASE+" are not supported");return t.daysBetween(e,t.ORDINAL_BASE)},fromOrdinal:function(e){var n=e*t.ONE_DAY;return new Date(t.ORDINAL_BASE.getTime()-t.tzOffset(t.ORDINAL_BASE)+n+t.tzOffset(new Date(n)))},monthRange:function(e,n){var r=new Date(e,n,1);return[t.getWeekday(r),t.getMonthDays(r)]},getMonthDays:function(e){var n=e.getMonth();return 1===n&&t.isLeapYear(e.getFullYear())?29:t.MONTH_DAYS[n]},getWeekday:function(e){return t.PY_WEEKDAYS[e.getDay()]},combine:function(e,t){return t=t||e,new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds())},clone:function(e){return new Date(e.getTime())},cloneDates:function(e){for(var n=[],r=0;r<e.length;r++)n.push(t.clone(e[r]));return n},sort:function(e){e.sort(function(e,t){return e.getTime()-t.getTime()})},timeToUntilString:function(e){for(var t,n=new Date(e),r=[n.getUTCFullYear(),n.getUTCMonth()+1,n.getUTCDate(),"T",n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds(),"Z"],i=0;i<r.length;i++)t=r[i],!/[TZ]/.test(t)&&t<10&&(r[i]="0"+String(t));return r.join("")},untilStringToDate:function(e){var t=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/.exec(e);if(!t)throw new Error("Invalid UNTIL value: "+e);return new Date(Date.UTC(t[1],t[2]-1,t[3],t[5]||0,t[6]||0,t[7]||0))},Time:function(e,t,n,r){this.hour=e,this.minute=t,this.second=n,this.millisecond=r||0}};t.Time.prototype={constructor:t.Time,getHours:function(){return this.hour},getMinutes:function(){return this.minute},getSeconds:function(){return this.second},getMilliseconds:function(){return this.millisecond},getTime:function(){return 1e3*(60*this.hour*60+60*this.minute+this.second)+this.millisecond}};var n=function(e,t){1===arguments.length&&(t=e,e=0);for(var n=[],r=e;r<t;r++)n.push(r);return n},r=function(e,t){var n=0,r=[];if(e instanceof Array)for(;n<t;n++)r[n]=[].concat(e);else for(;n<t;n++)r[n]=e;return r},i=function(e,t){var n=e%t;return n*t<0?n+t:n},a=function(e,t){return{div:Math.floor(e/t),mod:i(e,t)}},o=function(e){return!(e instanceof Array&&0===e.length)&&Boolean(e)},s=function(e,t){return-1!==e.indexOf(t)},l=[].concat(r(1,31),r(2,28),r(3,31),r(4,30),r(5,31),r(6,30),r(7,31),r(8,31),r(9,30),r(10,31),r(11,30),r(12,31),r(1,7)),h=[].concat(r(1,31),r(2,29),r(3,31),r(4,30),r(5,31),r(6,30),r(7,31),r(8,31),r(9,30),r(10,31),r(11,30),r(12,31),r(1,7)),u=n(1,29),f=n(1,30),c=n(1,31),y=n(1,32),d=[].concat(y,f,y,c,y,c,y,y,c,y,c,y,y.slice(0,7)),p=[].concat(y,u,y,c,y,c,y,y,c,y,c,y,y.slice(0,7));u=n(-28,0),f=n(-29,0),c=n(-30,0),y=n(-31,0);var w=[].concat(y,f,y,c,y,c,y,y,c,y,c,y,y.slice(0,7)),m=[].concat(y,u,y,c,y,c,y,y,c,y,c,y,y.slice(0,7)),b=[0,31,60,91,121,152,182,213,244,274,305,335,366],g=[0,31,59,90,120,151,181,212,243,273,304,334,365],_=function(){for(var e=[],t=0;t<55;t++)e=e.concat(n(7));return e}(),E=["MO","TU","WE","TH","FR","SA","SU"],k=function(e,t){if(0===t)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t};k.prototype={constructor:k,nth:function(e){return this.n===e?this:new k(this.weekday,e)},equals:function(e){return this.weekday===e.weekday&&this.n===e.n},toString:function(){var e=E[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},getJsWeekday:function(){return 6===this.weekday?0:this.weekday+1}};var T=function(e,n){e=e||{},this._string=null,this._cache=n?null:{all:!1,before:[],after:[],between:[]},this.origOptions={},this.options={};var r=[],i=Object.keys(e),a=Object.keys(T.DEFAULT_OPTIONS);if(i.forEach(function(t){this.origOptions[t]=e[t],this.options[t]=e[t],s(a,t)||r.push(t)},this),r.length)throw new Error("Invalid options: "+r.join(", "));if(!T.FREQUENCIES[e.freq]&&null===e.byeaster)throw new Error("Invalid frequency: "+String(e.freq));a.forEach(function(e){s(i,e)||(this.options[e]=T.DEFAULT_OPTIONS[e])},this);var l=this.options;null!==l.byeaster&&(l.freq=T.YEARLY),l.dtstart||(l.dtstart=new Date((new Date).setMilliseconds(0)));var h=l.dtstart.getTime()%1e3;if(null===l.wkst?l.wkst=T.MO.weekday:"number"==typeof l.wkst||(l.wkst=l.wkst.weekday),null!==l.bysetpos){"number"==typeof l.bysetpos&&(l.bysetpos=[l.bysetpos]);for(var u=0;u<l.bysetpos.length;u++){var f=l.bysetpos[u];if(0===f||!(f>=-366&&f<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(o(l.byweekno)||o(l.byyearday)||o(l.bymonthday)||null!==l.byweekday||null!==l.byeaster))switch(l.freq){case T.YEARLY:l.bymonth||(l.bymonth=l.dtstart.getMonth()+1),l.bymonthday=l.dtstart.getDate();break;case T.MONTHLY:l.bymonthday=l.dtstart.getDate();break;case T.WEEKLY:l.byweekday=t.getWeekday(l.dtstart)}if(null===l.bymonth||l.bymonth instanceof Array||(l.bymonth=[l.bymonth]),null===l.byyearday||l.byyearday instanceof Array||(l.byyearday=[l.byyearday]),null===l.bymonthday)l.bymonthday=[],l.bynmonthday=[];else if(l.bymonthday instanceof Array){var c=[],y=[];for(u=0;u<l.bymonthday.length;u++)(f=l.bymonthday[u])>0?c.push(f):f<0&&y.push(f);l.bymonthday=c,l.bynmonthday=y}else l.bymonthday<0?(l.bynmonthday=[l.bymonthday],l.bymonthday=[]):(l.bynmonthday=[],l.bymonthday=[l.bymonthday]);if(null===l.byweekno||l.byweekno instanceof Array||(l.byweekno=[l.byweekno]),null===l.byweekday)l.bynweekday=null;else if("number"==typeof l.byweekday)l.byweekday=[l.byweekday],l.bynweekday=null;else if(l.byweekday instanceof k)!l.byweekday.n||l.freq>T.MONTHLY?(l.byweekday=[l.byweekday.weekday],l.bynweekday=null):(l.bynweekday=[[l.byweekday.weekday,l.byweekday.n]],l.byweekday=null);else{var d=[],p=[];for(u=0;u<l.byweekday.length;u++){var w=l.byweekday[u];"number"==typeof w?d.push(w):!w.n||l.freq>T.MONTHLY?d.push(w.weekday):p.push([w.weekday,w.n])}l.byweekday=o(d)?d:null,l.bynweekday=o(p)?p:null}if(null===l.byhour?l.byhour=l.freq<T.HOURLY?[l.dtstart.getHours()]:null:"number"==typeof l.byhour&&(l.byhour=[l.byhour]),null===l.byminute?l.byminute=l.freq<T.MINUTELY?[l.dtstart.getMinutes()]:null:"number"==typeof l.byminute&&(l.byminute=[l.byminute]),null===l.bysecond?l.bysecond=l.freq<T.SECONDLY?[l.dtstart.getSeconds()]:null:"number"==typeof l.bysecond&&(l.bysecond=[l.bysecond]),l.freq>=T.HOURLY)this.timeset=null;else{for(this.timeset=[],u=0;u<l.byhour.length;u++)for(var m=l.byhour[u],b=0;b<l.byminute.length;b++)for(var g=l.byminute[b],_=0;_<l.bysecond.length;_++){var E=l.bysecond[_];this.timeset.push(new t.Time(m,g,E,h))}t.sort(this.timeset)}};T.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],T.YEARLY=0,T.MONTHLY=1,T.WEEKLY=2,T.DAILY=3,T.HOURLY=4,T.MINUTELY=5,T.SECONDLY=6,T.MO=new k(0),T.TU=new k(1),T.WE=new k(2),T.TH=new k(3),T.FR=new k(4),T.SA=new k(5),T.SU=new k(6),T.DEFAULT_OPTIONS={freq:null,dtstart:null,interval:1,wkst:T.MO,count:null,until:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},T.parseText=function(e,t){return L().parseText(e,t)},T.fromText=function(e,t){return L().fromText(e,t)},T.optionsToString=function(e){for(var n,r,i,a=[],o=Object.keys(e),l=Object.keys(T.DEFAULT_OPTIONS),h=0;h<o.length;h++)if(s(l,o[h])&&(n=o[h].toUpperCase(),i=[],!(null===(r=e[o[h]])||r instanceof Array&&!r.length))){switch(n){case"FREQ":r=T.FREQUENCIES[e.freq];break;case"WKST":r instanceof k||(r=new k(r));break;case"BYWEEKDAY":n="BYDAY",r instanceof Array||(r=[r]);for(var u,f=0;f<r.length;f++)(u=r[f])instanceof k||(u=u instanceof Array?new k(u[0],u[1]):new k(u)),i[f]=u.toString();r=i;break;case"DTSTART":case"UNTIL":r=t.timeToUntilString(r);break;default:if(r instanceof Array){for(f=0;f<r.length;f++)i[f]=String(r[f]);r=i}else r=String(r)}a.push([n,r])}var c=[];for(h=0;h<a.length;h++){var y=a[h];c.push(y[0]+"="+y[1].toString())}return c.join(";")},T.prototype={constructor:T,all:function(e){if(e)return this._iter(new v("all",{},e));var t=this._cacheGet("all");return!1===t&&(t=this._iter(new D("all",{})),this._cacheAdd("all",t)),t},between:function(e,t,n,r){var i={before:t,after:e,inc:n};if(r)return this._iter(new v("between",i,r));var a=this._cacheGet("between",i);return!1===a&&(a=this._iter(new D("between",i)),this._cacheAdd("between",a,i)),a},before:function(e,t){var n={dt:e,inc:t},r=this._cacheGet("before",n);return!1===r&&(r=this._iter(new D("before",n)),this._cacheAdd("before",r,n)),r},after:function(e,t){var n={dt:e,inc:t},r=this._cacheGet("after",n);return!1===r&&(r=this._iter(new D("after",n)),this._cacheAdd("after",r,n)),r},count:function(){return this.all().length},toString:function(){return T.optionsToString(this.origOptions)},toText:function(e,t){return L().toText(this,e,t)},isFullyConvertibleToText:function(){return L().isFullyConvertible(this)},_cacheAdd:function(e,n,r){this._cache&&(n&&(n=n instanceof Date?t.clone(n):t.cloneDates(n)),"all"===e?this._cache.all=n:(r._value=n,this._cache[e].push(r)))},_cacheGet:function(e,n){if(!this._cache)return!1;var r=!1,i=n?Object.keys(n):[],a=function(e){for(var t,r=0;r<i.length;r++)if(t=i[r],String(n[t])!==String(e[t]))return!0;return!1};if("all"===e)r=this._cache.all;else for(var o,s=0;s<this._cache[e].length;s++)if(o=this._cache[e][s],!i.length||!a(o)){r=o._value;break}if(!r&&this._cache.all){var l=new D(e,n);for(s=0;s<this._cache.all.length&&l.accept(this._cache.all[s]);s++);r=l.getValue(),this._cacheAdd(e,r,n)}return r instanceof Array?t.cloneDates(r):r instanceof Date?t.clone(r):r},clone:function(){return new T(this.origOptions)},_iter:function(e){var n=this.options.dtstart,r=this.options.dtstart%1e3,l=n.getFullYear(),h=n.getMonth()+1,u=n.getDate(),f=n.getHours(),c=n.getMinutes(),y=n.getSeconds(),d=t.getWeekday(n),p=this.options.freq,w=this.options.interval,m=this.options.wkst,b=this.options.until,g=this.options.bymonth,_=this.options.byweekno,E=this.options.byyearday,k=this.options.byweekday,D=this.options.byeaster,v=this.options.bymonthday,R=this.options.bynmonthday,O=this.options.bysetpos,A=this.options.byhour,L=this.options.byminute,S=this.options.bysecond,N=new Y(this);N.rebuild(l,h);var U,M={};if(M[T.YEARLY]=N.ydayset,M[T.MONTHLY]=N.mdayset,M[T.WEEKLY]=N.wdayset,M[T.DAILY]=N.ddayset,M[T.HOURLY]=N.ddayset,M[T.MINUTELY]=N.ddayset,M[T.SECONDLY]=N.ddayset,M=M[p],p<T.HOURLY)U=this.timeset;else{var x={};x[T.HOURLY]=N.htimeset,x[T.MINUTELY]=N.mtimeset,x[T.SECONDLY]=N.stimeset,x=x[p],U=p>=T.HOURLY&&o(A)&&!s(A,f)||p>=T.MINUTELY&&o(L)&&!s(L,c)||p>=T.SECONDLY&&o(S)&&!s(S,y)?[]:x.call(N,f,c,y,r)}for(var I,H,C,B,z,W,F,q,j,K,V,P,X,G=0,Q=this.options.count;;){for(j=(F=M.call(N,l,h,u))[0],K=F[1],V=F[2],X=!1,H=K;H<V;H++)I=j[H],(X=o(g)&&!s(g,N.mmask[I])||o(_)&&!N.wnomask[I]||o(k)&&!s(k,N.wdaymask[I])||o(N.nwdaymask)&&!N.nwdaymask[I]||null!==D&&!s(N.eastermask,I)||(o(v)||o(R))&&!s(v,N.mdaymask[I])&&!s(R,N.nmdaymask[I])||o(E)&&(I<N.yearlen&&!s(E,I+1)&&!s(E,-N.yearlen+I)||I>=N.yearlen&&!s(E,I+1-N.yearlen)&&!s(E,-N.nextyearlen+I-N.yearlen)))&&(j[I]=null);if(o(O)&&o(U)){var $,Z,J=[];for(H=0;H<O.length;H++){(q=O[H])<0?($=Math.floor(q/U.length),Z=i(q,U.length)):($=Math.floor((q-1)/U.length),Z=i(q-1,U.length));try{for(F=[],C=K;C<V;C++){var ee=j[C];null!==ee&&F.push(ee)}I=$<0?F.slice($)[0]:F[$];var te=U[Z],ne=t.fromOrdinal(N.yearordinal+I),re=t.combine(ne,te);s(J,re)||J.push(re)}catch(e){}}for(t.sort(J),H=0;H<J.length;H++){if(re=J[H],b&&re>b)return this._len=G,e.getValue();if(re>=n){if(++G,!e.accept(re))return e.getValue();if(Q&&!--Q)return this._len=G,e.getValue()}}}else for(H=K;H<V;H++)if(null!==(I=j[H]))for(ne=t.fromOrdinal(N.yearordinal+I),C=0;C<U.length;C++){if(te=U[C],re=t.combine(ne,te),b&&re>b)return this._len=G,e.getValue();if(re>=n){if(++G,!e.accept(re))return e.getValue();if(Q&&!--Q)return this._len=G,e.getValue()}}if(P=!1,p===T.YEARLY){if((l+=w)>t.MAXYEAR)return this._len=G,e.getValue();N.rebuild(l,h)}else if(p===T.MONTHLY){if((h+=w)>12&&(l+=z=Math.floor(h/12),0===(h=W=i(h,12))&&(h=12,--l),l>t.MAXYEAR))return this._len=G,e.getValue();N.rebuild(l,h)}else if(p===T.WEEKLY)u+=m>d?7*w-(d+1+(6-m)):7*w-(d-m),d=m,P=!0;else if(p===T.DAILY)u+=w,P=!0;else if(p===T.HOURLY){for(X&&(f+=Math.floor((23-f)/w)*w);z=(B=a(f+=w,24)).div,W=B.mod,z&&(f=W,u+=z,P=!0),o(A)&&!s(A,f););U=x.call(N,f,c,y)}else if(p===T.MINUTELY){for(X&&(c+=Math.floor((1439-(60*f+c))/w)*w);z=(B=a(c+=w,60)).div,W=B.mod,z&&(c=W,z=(B=a(f+=z,24)).div,W=B.mod,z&&(f=W,u+=z,P=!0,X=!1)),o(A)&&!s(A,f)||o(L)&&!s(L,c););U=x.call(N,f,c,y)}else if(p===T.SECONDLY){for(X&&(y+=Math.floor((86399-(3600*f+60*c+y))/w)*w);z=(B=a(y+=w,60)).div,W=B.mod,z&&(y=W,z=(B=a(c+=z,60)).div,W=B.mod,z&&(c=W,z=(B=a(f+=z,24)).div,W=B.mod,z&&(f=W,u+=z,P=!0))),o(A)&&!s(A,f)||o(L)&&!s(L,c)||o(S)&&!s(S,y););U=x.call(N,f,c,y)}if(P&&u>28){var ie=t.monthRange(l,h-1)[1];if(u>ie){for(;u>ie;){if(u-=ie,13===++h&&(h=1,++l>t.MAXYEAR))return this._len=G,e.getValue();ie=t.monthRange(l,h-1)[1]}N.rebuild(l,h)}}}}},T.parseString=function(e){if(!(e=e.replace(/^\s+|\s+$/,"")).length)return null;var n,r,i,a,o,s=e.split(";"),l={};for(n=0;n<s.length;n++)switch(i=(o=s[n].split("="))[0],a=o[1],i){case"FREQ":l.freq=T[a];break;case"WKST":l.wkst=T[a];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":if(-1!==a.indexOf(","))for(a=a.split(","),r=0;r<a.length;r++)/^[+-]?\d+$/.test(a[r])&&(a[r]=Number(a[r]));else/^[+-]?\d+$/.test(a)&&(a=Number(a));l[i=i.toLowerCase()]=a;break;case"BYDAY":var h,u,f,c=a.split(",");for(l.byweekday=[],r=0;r<c.length;r++)2===(f=c[r]).length?(u=T[f],l.byweekday.push(u)):(f=f.match(/^([+-]?\d)([A-Z]{2})$/),h=Number(f[1]),u=f[2],u=T[u].weekday,l.byweekday.push(new k(u,h)));break;case"DTSTART":l.dtstart=t.untilStringToDate(a);break;case"UNTIL":l.until=t.untilStringToDate(a);break;case"BYEASTER":l.byeaster=Number(a);break;default:throw new Error("Unknown RRULE property '"+i+"'")}return l},T.fromString=function(e){return new T(T.parseString(e))};var Y=function(e){this.rrule=e,this.lastyear=null,this.lastmonth=null,this.yearlen=null,this.nextyearlen=null,this.yearordinal=null,this.yearweekday=null,this.mmask=null,this.mrange=null,this.mdaymask=null,this.nmdaymask=null,this.wdaymask=null,this.wnomask=null,this.nwdaymask=null,this.eastermask=null};Y.prototype.easter=function(e,t){t=t||0;var n=e%19,r=Math.floor(e/100),i=e%100,a=Math.floor(r/4),o=r%4,s=Math.floor((r+8)/25),l=Math.floor((r-s+1)/3),h=Math.floor(19*n+r-a-l+15)%30,u=Math.floor(i/4),f=i%4,c=Math.floor(32+2*o+2*u-h-f)%7,y=Math.floor((n+11*h+22*c)/451),d=Math.floor((h+c-7*y+114)/31),p=(h+c-7*y+114)%31+1,w=Date.UTC(e,d-1,p+t),m=Date.UTC(e,0,1);return[Math.ceil((w-m)/864e5)]},Y.prototype.rebuild=function(e,n){var a=this.rrule;if(e!==this.lastyear){this.yearlen=t.isLeapYear(e)?366:365,this.nextyearlen=t.isLeapYear(e+1)?366:365;var u=new Date(e,0,1);this.yearordinal=t.toOrdinal(u),this.yearweekday=t.getWeekday(u);var f=t.getWeekday(new Date(e,0,1));if(365===this.yearlen?(this.mmask=[].concat(l),this.mdaymask=[].concat(p),this.nmdaymask=[].concat(m),this.wdaymask=_.slice(f),this.mrange=[].concat(g)):(this.mmask=[].concat(h),this.mdaymask=[].concat(d),this.nmdaymask=[].concat(w),this.wdaymask=_.slice(f),this.mrange=[].concat(b)),o(a.options.byweekno)){var c,y,E;this.wnomask=r(0,this.yearlen+7),(c=y=i(7-this.yearweekday+a.options.wkst,7))>=4?(c=0,E=this.yearlen+i(this.yearweekday-a.options.wkst,7)):E=this.yearlen-c;for(var k,Y,D=Math.floor(E/7),v=i(E,7),R=Math.floor(D+v/4),O=0;O<a.options.byweekno.length;O++)if((k=a.options.byweekno[O])<0&&(k+=R+1),k>0&&k<=R){k>1?(Y=c+7*(k-1),c!==y&&(Y-=7-y)):Y=c;for(var A=0;A<7&&(this.wnomask[Y]=1,Y++,this.wdaymask[Y]!==a.options.wkst);A++);}if(s(a.options.byweekno,1)&&(Y=c+7*R,c!==y&&(Y-=7-y),Y<this.yearlen))for(O=0;O<7&&(this.wnomask[Y]=1,Y+=1,this.wdaymask[Y]!==a.options.wkst);O++);if(c){var L;if(s(a.options.byweekno,-1))L=-1;else{var S=t.getWeekday(new Date(e-1,0,1)),N=i(7-S+a.options.wkst,7),U=t.isLeapYear(e-1)?366:365;N>=4?(N=0,L=Math.floor(52+i(U+i(S-a.options.wkst,7),7)/4)):L=Math.floor(52+i(this.yearlen-c,7)/4)}if(s(a.options.byweekno,L))for(Y=0;Y<c;Y++)this.wnomask[Y]=1}}else this.wnomask=null}if(o(a.options.bynweekday)&&(n!==this.lastmonth||e!==this.lastyear)){var M=[];if(a.options.freq===T.YEARLY)if(o(a.options.bymonth))for(O=0;O<a.options.bymonth.length;O++)n=a.options.bymonth[O],M.push(this.mrange.slice(n-1,n+1));else M=[[0,this.yearlen]];else a.options.freq===T.MONTHLY&&(M=[this.mrange.slice(n-1,n+1)]);if(o(M))for(this.nwdaymask=r(0,this.yearlen),O=0;O<M.length;O++){var x=M[O],I=x[0],H=x[1];for(H-=1,A=0;A<a.options.bynweekday.length;A++)f=a.options.bynweekday[A][0],(k=a.options.bynweekday[A][1])<0?(Y=H+7*(k+1),Y-=i(this.wdaymask[Y]-f,7)):(Y=I+7*(k-1),Y+=i(7-this.wdaymask[Y]+f,7)),I<=Y&&Y<=H&&(this.nwdaymask[Y]=1)}this.lastyear=e,this.lastmonth=n}null!==a.options.byeaster&&(this.eastermask=this.easter(e,a.options.byeaster))},Y.prototype.ydayset=function(e,t,r){return[n(this.yearlen),0,this.yearlen]},Y.prototype.mdayset=function(e,t,n){for(var i=r(null,this.yearlen),a=this.mrange[t-1],o=this.mrange[t],s=a;s<o;s++)i[s]=s;return[i,a,o]},Y.prototype.wdayset=function(e,n,i){for(var a=r(null,this.yearlen+7),o=t.toOrdinal(new Date(e,n-1,i))-this.yearordinal,s=o,l=0;l<7&&(a[o]=o,++o,this.wdaymask[o]!==this.rrule.options.wkst);l++);return[a,s,o]},Y.prototype.ddayset=function(e,n,i){var a=r(null,this.yearlen),o=t.toOrdinal(new Date(e,n-1,i))-this.yearordinal;return a[o]=o,[a,o,o+1]},Y.prototype.htimeset=function(e,n,r,i){for(var a=[],o=this.rrule,s=0;s<o.options.byminute.length;s++){n=o.options.byminute[s];for(var l=0;l<o.options.bysecond.length;l++)r=o.options.bysecond[l],a.push(new t.Time(e,n,r,i))}return t.sort(a),a},Y.prototype.mtimeset=function(e,n,r,i){for(var a=[],o=this.rrule,s=0;s<o.options.bysecond.length;s++)r=o.options.bysecond[s],a.push(new t.Time(e,n,r,i));return t.sort(a),a},Y.prototype.stimeset=function(e,n,r,i){return[new t.Time(e,n,r,i)]};var D=function(e,t){this.init(e,t)};D.prototype={constructor:D,init:function(e,t){this.method=e,this.args=t,this.minDate=null,this.maxDate=null,this._result=[],"between"===e?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):"before"===e?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):"after"===e&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))},accept:function(e){var t=this.minDate&&e<this.minDate,n=this.maxDate&&e>this.maxDate;if("between"===this.method){if(t)return!0;if(n)return!1}else if("before"===this.method){if(n)return!1}else if("after"===this.method)return!!t||(this.add(e),!1);return this.add(e)},add:function(e){return this._result.push(e),!0},getValue:function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":return e.length?e[e.length-1]:null}},clone:function(){return new D(this.method,this.args)}};var v=function(e,t,n){if(!s(["all","between"],e))throw new Error('Invalid method "'+e+'". Only all and between works with iterator.');this.add=function(e){return!!n(e,this._result.length)&&(this._result.push(e),!0)},this.init(e,t)};v.prototype=D.prototype;var R=function(e){this._cache=e?null:{all:!1,before:[],after:[],between:[]},this._rrule=[],this._rdate=[],this._exrule=[],this._exdate=[]};R.prototype={constructor:R,rrule:function(e){if(!(e instanceof T))throw new TypeError(String(e)+" is not RRule instance");s(this._rrule.map(String),String(e))||this._rrule.push(e)},rdate:function(e){if(!(e instanceof Date))throw new TypeError(String(e)+" is not Date instance");s(this._rdate.map(Number),Number(e))||(this._rdate.push(e),t.sort(this._rdate))},exrule:function(e){if(!(e instanceof T))throw new TypeError(String(e)+" is not RRule instance");s(this._exrule.map(String),String(e))||this._exrule.push(e)},exdate:function(e){if(!(e instanceof Date))throw new TypeError(String(e)+" is not Date instance");s(this._exdate.map(Number),Number(e))||(this._exdate.push(e),t.sort(this._exdate))},valueOf:function(){var e=[];return this._rrule.length&&this._rrule.forEach(function(t){e.push("RRULE:"+t)}),this._rdate.length&&e.push("RDATE:"+this._rdate.map(function(e){return t.timeToUntilString(e)}).join(",")),this._exrule.length&&this._exrule.forEach(function(t){e.push("EXRULE:"+t)}),this._exdate.length&&e.push("EXDATE:"+this._exdate.map(function(e){return t.timeToUntilString(e)}).join(",")),e},toString:function(){return JSON.stringify(this.valueOf())},_iter:function(e){var n={},r=this._exrule,i=e.accept;function a(e,t){r.forEach(function(r){r.between(e,t,!0).forEach(function(e){n[Number(e)]=!0})})}this._exdate.forEach(function(e){n[Number(e)]=!0}),e.accept=function(e){var t=Number(e);return!(!n[t]&&(a(new Date(t-1),new Date(t+1)),!n[t]))||(n[t]=!0,i.call(this,e))},"between"===e.method&&(a(e.args.after,e.args.before),e.accept=function(e){var t=Number(e);return!!n[t]||(n[t]=!0,i.call(this,e))});for(var o=0;o<this._rdate.length&&e.accept(new Date(this._rdate[o]));o++);this._rrule.forEach(function(t){t._iter(e)});var s=e._result;switch(t.sort(s),e.method){case"all":case"between":return s;case"before":return s.length&&s[s.length-1]||null;case"after":return s.length&&s[0]||null;default:return null}},clone:function(){var e,t=new R(!!this._cache);for(e=0;e<this._rrule.length;e++)t.rrule(this._rrule[e].clone());for(e=0;e<this._rdate.length;e++)t.rdate(new Date(this._rdate[e]));for(e=0;e<this._exrule.length;e++)t.exrule(this._exrule[e].clone());for(e=0;e<this._exdate.length;e++)t.exdate(new Date(this._exdate[e]));return t}};["all","between","before","after","count","_cacheAdd","_cacheGet"].forEach(function(e){R.prototype[e]=T.prototype[e]});var O=function(){};O.DEFAULT_OPTIONS={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,ignoretz:!1,tzinfos:null},O._freq_map={YEARLY:T.YEARLY,MONTHLY:T.MONTHLY,WEEKLY:T.WEEKLY,DAILY:T.DAILY,HOURLY:T.HOURLY,MINUTELY:T.MINUTELY,SECONDLY:T.SECONDLY},O._weekday_map={MO:0,TU:1,WE:2,TH:3,FR:4,SA:5,SU:6},(O.prototype={constructor:O,_handle_int:function(e,t,n,r){e[t.toLowerCase()]=parseInt(n,10)},_handle_int_list:function(e,t,n,r){e[t.toLowerCase()]=n.split(",").map(function(e){return parseInt(e,10)})},_handle_FREQ:function(e,t,n,r){e.freq=O._freq_map[n]},_handle_UNTIL:function(e,n,r,i){try{e.until=t.untilStringToDate(r)}catch(e){throw new Error("invalid until date")}},_handle_WKST:function(e,t,n,r){e.wkst=O._weekday_map[n]},_handle_BYWEEKDAY:function(e,t,n,r){var i,a,o,s,l,h,u=[],f=n.split(",");for(a=0;a<f.length;a++){if((h=f[a]).indexOf("(")>-1)l=(i=h.split("("))[0],s=parseInt(i.slice(1,-1),10);else{for(o=0;o<h.length&&-1!=="+-0123456789".indexOf(h[o]);o++);s=h.slice(0,o)||null,l=h.slice(o),s&&(s=parseInt(s,10))}var c=new k(O._weekday_map[l],s);u.push(c)}e.byweekday=u},_parseRfcRRule:function(e,t){var n,r,i,a;if((t=t||{}).dtstart=t.dtstart||null,t.cache=t.cache||!1,t.ignoretz=t.ignoretz||!1,t.tzinfos=t.tzinfos||null,-1!==e.indexOf(":")){if(i=e.split(":"),n=i[0],r=i[1],"RRULE"!==n)throw new Error("unknown parameter name")}else r=e;var o={},s=r.split(";");for(a=0;a<s.length;a++){i=s[a].split("="),n=i[0].toUpperCase(),r=i[1].toUpperCase();try{this["_handle_"+n](o,n,r,{ignoretz:t.ignoretz,tzinfos:t.tzinfos})}catch(e){throw new Error("unknown parameter '"+n+"':"+r)}}return o.dtstart=o.dtstart||t.dtstart,new T(o,!t.cache)},_parseRfc:function(e,n){if(n.compatible&&(n.forceset=!0,n.unfold=!0),!(e=e&&e.toUpperCase().trim()))throw new Error("Invalid empty string");var r,i,a=0;if(n.unfold)for(i=e.split("\n");a<i.length;)(r=i[a]=i[a].replace(/\s+$/g,""))?a>0&&" "===r[0]?(i[a-1]+=r.slice(1),i.splice(a,1)):a+=1:i.splice(a,1);else i=e.split(/\s/);var o,s,l,h,u,f,c,y,d,p,w,m,b,g,_=[],E=[],k=[],T=[];if(n.forceset||1!==i.length||-1!==e.indexOf(":")&&0!==e.indexOf("RRULE:")){for(a=0;a<i.length;a++)if(r=i[a]){if(-1===r.indexOf(":")?(o="RRULE",s=r):(m=":",b=1,g=void 0,g=r.split(m),o=(l=b?g.slice(0,b).concat([g.slice(b).join(m)]):g)[0],s=l[1]),!(h=o.split(";")))throw new Error("empty property name");if(o=h[0],h=h.slice(1),"RRULE"===o){for(y=0;y<h.length;y++)throw u=h[y],new Error("unsupported RRULE parm: "+u);_.push(s)}else if("RDATE"===o){for(y=0;y<h.length;y++)if("VALUE=DATE-TIME"!==(u=h[y])&&"VALUE=DATE"!==u)throw new Error("unsupported RDATE parm: "+u);E.push(s)}else if("EXRULE"===o){for(y=0;y<h.length;y++)throw u=h[y],new Error("unsupported EXRULE parm: "+u);k.push(s)}else if("EXDATE"===o){for(y=0;y<h.length;y++)if("VALUE=DATE-TIME"!==(u=h[y])&&"VALUE=DATE"!==u)throw new Error("unsupported RDATE parm: "+u);T.push(s)}else{if("DTSTART"!==o)throw new Error("unsupported property: "+o);f=t.untilStringToDate(s)}}if(n.forceset||_.length>1||E.length||k.length||T.length){for(c=new R(!n.cache),y=0;y<_.length;y++)c.rrule(this._parseRfcRRule(_[y],{dtstart:n.dtstart||f,ignoretz:n.ignoretz,tzinfos:n.tzinfos}));for(y=0;y<E.length;y++)for(p=E[y].split(","),d=0;d<p.length;d++)w=p[d],c.rdate(t.untilStringToDate(w));for(y=0;y<k.length;y++)c.exrule(this._parseRfcRRule(k[y],{dtstart:n.dtstart||f,ignoretz:n.ignoretz,tzinfos:n.tzinfos}));for(y=0;y<T.length;y++)for(p=T[y].split(","),d=0;d<p.length;d++)w=p[d],c.exdate(t.untilStringToDate(w));return n.campatiable&&n.dtstart&&c.rdate(f),c}return this._parseRfcRRule(_[0],{dtstart:n.dtstart||f,cache:n.cache,ignoretz:n.ignoretz,tzinfos:n.tzinfos})}return this._parseRfcRRule(i[0],{cache:n.cache,dtstart:n.dtstart,ignoretz:n.ignoretz,tzinfos:n.tzinfos})},parse:function(e,t){t=t||{};var n=[],r=Object.keys(t),i=Object.keys(O.DEFAULT_OPTIONS);if(r.forEach(function(e){s(i,e)||n.push(e)},this),n.length)throw new Error("Invalid options: "+n.join(", "));return i.forEach(function(e){s(r,e)||(t[e]=O.DEFAULT_OPTIONS[e])}),this._parseRfc(e,t)}})._handle_DTSTART=function(e,n,r,i){e[n.toLowerCase()]=t.untilStringToDate(r)},O.prototype._handle_BYDAY=O.prototype._handle_BYWEEKDAY,O.prototype._handle_INTERVAL=O.prototype._handle_int,O.prototype._handle_COUNT=O.prototype._handle_int,["_handle_BYSETPOS","_handle_BYMONTH","_handle_BYMONTHDAY","_handle_BYYEARDAY","_handle_BYEASTER","_handle_BYWEEKNO","_handle_BYHOUR","_handle_BYMINUTE","_handle_BYSECOND"].forEach(function(e){O.prototype[e]=O.prototype._handle_int_list});var A=new O;return T.RRule=T,T.RRuleSet=R,T.rrulestr=function(){return A.parse.apply(A,arguments)},T;function L(){if(!L._nlp)if(e&&e._getRRuleNLP)L._nlp=e._getRRuleNLP(T);else{if("function"!=typeof require)throw new Error("You need to include rrule/nlp.js for fromText/toText to work.");L._nlp=require("./nlp")(T)}return L._nlp}});