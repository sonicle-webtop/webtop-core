!function e(t,r,s){function n(i,o){if(!r[i]){if(!t[i]){var l="function"==typeof require&&require;if(!o&&l)return l(i,!0);if(a)return a(i,!0);var p=new Error("Cannot find module '"+i+"'");throw p.code="MODULE_NOT_FOUND",p}var c=r[i]={exports:{}};t[i][0].call(c.exports,(function(e){return n(t[i][1][e]||e)}),c,c.exports,e,t,r,s)}return r[i].exports}for(var a="function"==typeof require&&require,i=0;i<s.length;i++)n(s[i]);return n}({1:[function(e,t,r){const s=e("./evaluator/Evaluator"),n=e("./Lexer"),a=e("./parser/Parser"),i=e("./PromiseSync");t.exports=class{constructor(e,t){this._grammar=e,this._exprStr=t,this._ast=null}compile(){const e=new n(this._grammar),t=new a(this._grammar),r=e.tokenize(this._exprStr);return t.addTokens(r),this._ast=t.complete(),this}eval(e={}){return this._eval(e,Promise)}evalSync(e={}){const t=this._eval(e,i);if(t.error)throw t.error;return t.value}_eval(e,t){return t.resolve().then((()=>{const r=this._getAst();return new s(this._grammar,e,void 0,t).eval(r)}))}_getAst(){return this._ast||this.compile(),this._ast}}},{"./Lexer":3,"./PromiseSync":4,"./evaluator/Evaluator":5,"./parser/Parser":8}],2:[function(e,t,r){const s=e("./Expression"),{getGrammar:n}=e("./grammar");class a{constructor(){this.expr=this.expr.bind(this),this._grammar=n()}addBinaryOp(e,t,r,s){this._addGrammarElement(e,{type:"binaryOp",precedence:t,[s?"evalOnDemand":"eval"]:r})}addFunction(e,t){this._grammar.functions[e]=t}addFunctions(e){for(let t in e)this._grammar.functions[t]=e[t]}addUnaryOp(e,t){this._addGrammarElement(e,{type:"unaryOp",weight:1/0,eval:t})}addTransform(e,t){this._grammar.transforms[e]=t}addTransforms(e){for(let t in e)this._grammar.transforms[t]=e[t]}compile(e){return this.createExpression(e).compile()}createExpression(e){return new s(this._grammar,e)}getFunction(e){return this._grammar.functions[e]}getTransform(e){return this._grammar.transforms[e]}eval(e,t={}){return this.createExpression(e).eval(t)}evalSync(e,t={}){return this.createExpression(e).evalSync(t)}expr(e,...t){const r=e.reduce(((e,r,s)=>e+=r+(s<t.length?t[s]:"")),"");return this.createExpression(r)}removeOp(e){!this._grammar.elements[e]||"binaryOp"!==this._grammar.elements[e].type&&"unaryOp"!==this._grammar.elements[e].type||delete this._grammar.elements[e]}_addGrammarElement(e,t){this._grammar.elements[e]=t}}t.exports=new a,t.exports.Jexl=a},{"./Expression":1,"./grammar":7}],3:[function(e,t,r){const s=/^-?(?:(?:[0-9]*\.[0-9]+)|[0-9]+)$/,n=/^[a-zA-Zа-яА-Я_\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u00FF$][a-zA-Zа-яА-Я0-9_\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u00FF$]*$/,a=/\\\\/,i=/^\s*$/,o=["'(?:(?:\\\\')|[^'])*'",'"(?:(?:\\\\")|[^"])*"',"\\s+","\\btrue\\b","\\bfalse\\b"],l=["[a-zA-Zа-яА-Я_À-ÖØ-öø-ÿ\\$][a-zA-Z0-9а-яА-Я_À-ÖØ-öø-ÿ\\$]*","(?:(?:[0-9]*\\.[0-9]+)|[0-9]+)"],p=["binaryOp","unaryOp","openParen","openBracket","question","colon"];t.exports=class{constructor(e){this._grammar=e}getElements(e){const t=this._getSplitRegex();return e.split(t).filter((e=>e))}getTokens(e){const t=[];let r=!1;for(let s=0;s<e.length;s++)this._isWhitespace(e[s])?t.length&&(t[t.length-1].raw+=e[s]):"-"===e[s]&&this._isNegative(t)?r=!0:(r&&(e[s]="-"+e[s],r=!1),t.push(this._createToken(e[s])));return r&&t.push(this._createToken("-")),t}tokenize(e){const t=this.getElements(e);return this.getTokens(t)}_createToken(e){const t={type:"literal",value:e,raw:e};if('"'===e[0]||"'"===e[0])t.value=this._unquote(e);else if(e.match(s))t.value=parseFloat(e);else if("true"===e||"false"===e)t.value="true"===e;else if(this._grammar.elements[e])t.type=this._grammar.elements[e].type;else{if(!e.match(n))throw new Error(`Invalid expression token: ${e}`);t.type="identifier"}return t}_escapeRegExp(e){return(e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).match(n)&&(e="\\b"+e+"\\b"),e}_getSplitRegex(){if(!this._splitRegex){const e=Object.keys(this._grammar.elements).sort(((e,t)=>t.length-e.length)).map((e=>this._escapeRegExp(e)),this);this._splitRegex=new RegExp("("+[o.join("|"),e.join("|"),l.join("|")].join("|")+")")}return this._splitRegex}_isNegative(e){return!e.length||p.some((t=>t===e[e.length-1].type))}_isWhitespace(e){return!!e.match(i)}_unquote(e){const t=e[0],r=new RegExp("\\\\"+t,"g");return e.substr(1,e.length-2).replace(r,t).replace(a,"\\")}}},{}],4:[function(e,t,r){class s{constructor(e){e(this._resolve.bind(this),this._reject.bind(this))}catch(e){if(this.error)try{this._resolve(e(this.error))}catch(e){this._reject(e)}return this}then(e,t){if(!this.error)try{this._resolve(e(this.value))}catch(e){this._reject(e)}return t&&this.catch(t),this}_reject(e){this.value=void 0,this.error=e}_resolve(e){e instanceof s?e.error?this._reject(e.error):this._resolve(e.value):(this.value=e,this.error=void 0)}}s.all=e=>new s((t=>{t(e.map((e=>{for(;e instanceof s;){if(e.error)throw Error(e.error);e=e.value}return e})))})),s.resolve=e=>new s((t=>t(e))),s.reject=e=>new s(((t,r)=>r(e))),t.exports=s},{}],5:[function(e,t,r){const s=e("./handlers");class n{constructor(e,t,r,s=Promise){this._grammar=e,this._context=t||{},this._relContext=r||this._context,this.Promise=s}eval(e){return this.Promise.resolve().then((()=>s[e.type].call(this,e)))}evalArray(e){return this.Promise.all(e.map((e=>this.eval(e))))}evalMap(e){const t=Object.keys(e),r={},s=t.map((t=>this.eval(e[t])));return this.Promise.all(s).then((e=>(e.forEach(((e,s)=>{r[t[s]]=e})),r)))}_filterRelative(e,t){const r=[];return Array.isArray(e)||(e=void 0===e?[]:[e]),e.forEach((e=>{const s=new n(this._grammar,this._context,e,this.Promise);r.push(s.eval(t))})),this.Promise.all(r).then((t=>{const r=[];return t.forEach(((t,s)=>{t&&r.push(e[s])})),r}))}_filterStatic(e,t){return this.eval(t).then((t=>"boolean"==typeof t?t?e:void 0:e[t]))}}t.exports=n},{"./handlers":6}],6:[function(e,t,r){const s={functions:"Jexl Function",transforms:"Transform"};r.ArrayLiteral=function(e){return this.evalArray(e.value)},r.BinaryExpression=function(e){const t=this._grammar.elements[e.operator];if(t.evalOnDemand){const r=e=>({eval:()=>this.eval(e)});return t.evalOnDemand(r(e.left),r(e.right))}return this.Promise.all([this.eval(e.left),this.eval(e.right)]).then((e=>t.eval(e[0],e[1])))},r.ConditionalExpression=function(e){return this.eval(e.test).then((t=>t?e.consequent?this.eval(e.consequent):t:this.eval(e.alternate)))},r.FilterExpression=function(e){return this.eval(e.subject).then((t=>e.relative?this._filterRelative(t,e.expr):this._filterStatic(t,e.expr)))},r.Identifier=function(e){return e.from?this.eval(e.from).then((t=>{if(null!=t)return Array.isArray(t)&&(t=t[0]),t[e.value]})):e.relative?this._relContext[e.value]:this._context[e.value]},r.Literal=function(e){return e.value},r.ObjectLiteral=function(e){return this.evalMap(e.value)},r.FunctionCall=function(e){const t=s[e.pool];if(!t)throw new Error(`Corrupt AST: Pool '${e.pool}' not found`);const r=this._grammar[e.pool][e.name];if(!r)throw new Error(`${t} ${e.name} is not defined.`);return this.evalArray(e.args||[]).then((e=>r(...e)))},r.UnaryExpression=function(e){return this.eval(e.right).then((t=>this._grammar.elements[e.operator].eval(t)))}},{}],7:[function(e,t,r){r.getGrammar=()=>({elements:{".":{type:"dot"},"[":{type:"openBracket"},"]":{type:"closeBracket"},"|":{type:"pipe"},"{":{type:"openCurl"},"}":{type:"closeCurl"},":":{type:"colon"},",":{type:"comma"},"(":{type:"openParen"},")":{type:"closeParen"},"?":{type:"question"},"+":{type:"binaryOp",precedence:30,eval:(e,t)=>e+t},"-":{type:"binaryOp",precedence:30,eval:(e,t)=>e-t},"*":{type:"binaryOp",precedence:40,eval:(e,t)=>e*t},"/":{type:"binaryOp",precedence:40,eval:(e,t)=>e/t},"//":{type:"binaryOp",precedence:40,eval:(e,t)=>Math.floor(e/t)},"%":{type:"binaryOp",precedence:50,eval:(e,t)=>e%t},"^":{type:"binaryOp",precedence:50,eval:(e,t)=>Math.pow(e,t)},"==":{type:"binaryOp",precedence:20,eval:(e,t)=>e==t},"!=":{type:"binaryOp",precedence:20,eval:(e,t)=>e!=t},">":{type:"binaryOp",precedence:20,eval:(e,t)=>e>t},">=":{type:"binaryOp",precedence:20,eval:(e,t)=>e>=t},"<":{type:"binaryOp",precedence:20,eval:(e,t)=>e<t},"<=":{type:"binaryOp",precedence:20,eval:(e,t)=>e<=t},"&&":{type:"binaryOp",precedence:10,evalOnDemand:(e,t)=>e.eval().then((e=>e?t.eval():e))},"||":{type:"binaryOp",precedence:10,evalOnDemand:(e,t)=>e.eval().then((e=>e||t.eval()))},in:{type:"binaryOp",precedence:20,eval:(e,t)=>"string"==typeof t?-1!==t.indexOf(e):!!Array.isArray(t)&&t.some((t=>t===e))},"!":{type:"unaryOp",precedence:1/0,eval:e=>!e}},functions:{},transforms:{}})},{}],8:[function(e,t,r){const s=e("./handlers"),n=e("./states").states;class a{constructor(e,t,r){this._grammar=e,this._state="expectOperand",this._tree=null,this._exprStr=t||"",this._relative=!1,this._stopMap=r||{}}addToken(e){if("complete"===this._state)throw new Error("Cannot add a new token to a completed Parser");const t=n[this._state],r=this._exprStr;if(this._exprStr+=e.raw,t.subHandler){this._subParser||this._startSubExpression(r);const t=this._subParser.addToken(e);if(t){if(this._endSubExpression(),this._parentStop)return t;this._state=t}}else{if(!t.tokenTypes[e.type]){if(this._stopMap[e.type])return this._stopMap[e.type];throw new Error(`Token ${e.raw} (${e.type}) unexpected in expression: ${this._exprStr}`)}{const r=t.tokenTypes[e.type];let n=s[e.type];r.handler&&(n=r.handler),n&&n.call(this,e),r.toState&&(this._state=r.toState)}}return!1}addTokens(e){e.forEach(this.addToken,this)}complete(){if(this._cursor&&!n[this._state].completable)throw new Error(`Unexpected end of expression: ${this._exprStr}`);return this._subParser&&this._endSubExpression(),this._state="complete",this._cursor?this._tree:null}isRelative(){return this._relative}_endSubExpression(){n[this._state].subHandler.call(this,this._subParser.complete()),this._subParser=null}_placeAtCursor(e){this._cursor?(this._cursor.right=e,this._setParent(e,this._cursor)):this._tree=e,this._cursor=e}_placeBeforeCursor(e){this._cursor=this._cursor._parent,this._placeAtCursor(e)}_setParent(e,t){Object.defineProperty(e,"_parent",{value:t,writable:!0})}_startSubExpression(e){let t=n[this._state].endStates;t||(this._parentStop=!0,t=this._stopMap),this._subParser=new a(this._grammar,e,t)}}t.exports=a},{"./handlers":9,"./states":10}],9:[function(e,t,r){r.argVal=function(e){e&&this._cursor.args.push(e)},r.arrayStart=function(){this._placeAtCursor({type:"ArrayLiteral",value:[]})},r.arrayVal=function(e){e&&this._cursor.value.push(e)},r.binaryOp=function(e){const t=this._grammar.elements[e.value].precedence||0;let r=this._cursor._parent;for(;r&&r.operator&&this._grammar.elements[r.operator].precedence>=t;)this._cursor=r,r=r._parent;const s={type:"BinaryExpression",operator:e.value,left:this._cursor};this._setParent(this._cursor,s),this._cursor=r,this._placeAtCursor(s)},r.dot=function(){this._nextIdentEncapsulate=this._cursor&&"UnaryExpression"!==this._cursor.type&&("BinaryExpression"!==this._cursor.type||"BinaryExpression"===this._cursor.type&&this._cursor.right),this._nextIdentRelative=!this._cursor||this._cursor&&!this._nextIdentEncapsulate,this._nextIdentRelative&&(this._relative=!0)},r.filter=function(e){this._placeBeforeCursor({type:"FilterExpression",expr:e,relative:this._subParser.isRelative(),subject:this._cursor})},r.functionCall=function(){this._placeBeforeCursor({type:"FunctionCall",name:this._cursor.value,args:[],pool:"functions"})},r.identifier=function(e){const t={type:"Identifier",value:e.value};this._nextIdentEncapsulate?(t.from=this._cursor,this._placeBeforeCursor(t),this._nextIdentEncapsulate=!1):(this._nextIdentRelative&&(t.relative=!0,this._nextIdentRelative=!1),this._placeAtCursor(t))},r.literal=function(e){this._placeAtCursor({type:"Literal",value:e.value})},r.objKey=function(e){this._curObjKey=e.value},r.objStart=function(){this._placeAtCursor({type:"ObjectLiteral",value:{}})},r.objVal=function(e){this._cursor.value[this._curObjKey]=e},r.subExpression=function(e){this._placeAtCursor(e)},r.ternaryEnd=function(e){this._cursor.alternate=e},r.ternaryMid=function(e){this._cursor.consequent=e},r.ternaryStart=function(){this._tree={type:"ConditionalExpression",test:this._tree},this._cursor=this._tree},r.transform=function(e){this._placeBeforeCursor({type:"FunctionCall",name:e.value,args:[this._cursor],pool:"transforms"})},r.unaryOp=function(e){this._placeAtCursor({type:"UnaryExpression",operator:e.value})}},{}],10:[function(e,t,r){const s=e("./handlers");r.states={expectOperand:{tokenTypes:{literal:{toState:"expectBinOp"},identifier:{toState:"identifier"},unaryOp:{},openParen:{toState:"subExpression"},openCurl:{toState:"expectObjKey",handler:s.objStart},dot:{toState:"traverse"},openBracket:{toState:"arrayVal",handler:s.arrayStart}}},expectBinOp:{tokenTypes:{binaryOp:{toState:"expectOperand"},pipe:{toState:"expectTransform"},dot:{toState:"traverse"},question:{toState:"ternaryMid",handler:s.ternaryStart}},completable:!0},expectTransform:{tokenTypes:{identifier:{toState:"postTransform",handler:s.transform}}},expectObjKey:{tokenTypes:{identifier:{toState:"expectKeyValSep",handler:s.objKey},closeCurl:{toState:"expectBinOp"}}},expectKeyValSep:{tokenTypes:{colon:{toState:"objVal"}}},postTransform:{tokenTypes:{openParen:{toState:"argVal"},binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},postArgs:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},identifier:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},openParen:{toState:"argVal",handler:s.functionCall},pipe:{toState:"expectTransform"},question:{toState:"ternaryMid",handler:s.ternaryStart}},completable:!0},traverse:{tokenTypes:{identifier:{toState:"identifier"}}},filter:{subHandler:s.filter,endStates:{closeBracket:"identifier"}},subExpression:{subHandler:s.subExpression,endStates:{closeParen:"expectBinOp"}},argVal:{subHandler:s.argVal,endStates:{comma:"argVal",closeParen:"postArgs"}},objVal:{subHandler:s.objVal,endStates:{comma:"expectObjKey",closeCurl:"expectBinOp"}},arrayVal:{subHandler:s.arrayVal,endStates:{comma:"arrayVal",closeBracket:"expectBinOp"}},ternaryMid:{subHandler:s.ternaryMid,endStates:{colon:"ternaryEnd"}},ternaryEnd:{subHandler:s.ternaryEnd,completable:!0}}},{"./handlers":9}],11:[function(e,t,r){(function(t){(function(){var r=e("./Jexl.js");t.window.Jexl=r}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./Jexl.js":2}]},{},[11]);
